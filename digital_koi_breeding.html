<!DOCTYPE html><html lang="en"><head><title>Job Talle | Digital koi breeding</title><meta charset="UTF-8"><meta name="description" content="In my fish breeding game Koi Farm, an infinite number of koi patterns can be explored through crossbreeding. The techniques I've used to simulate pattern mutation and crossbreeding are explained in this article, and an interactive javascript based pattern generator and mutator is included to demonstrate the algorithms."/><meta name="keywords" content="software development, AI, algorithms, programming, Job Talle"/><meta name="author" content="Job Talle"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:locale" content="en_US"/><meta property="og:title" content="Digital koi breeding"/><meta property="og:url" content="https://jobtalle.com/digital_koi_breeding.html"/><meta property="og:description" content="In my fish breeding game Koi Farm, an infinite number of koi patterns can be explored through crossbreeding. The techniques I've used to simulate pattern mutation and crossbreeding are explained in this article, and an interactive javascript based pattern generator and mutator is included to demonstrate the algorithms."/><meta property="og:image" content="https://jobtalle.com/posts/2022_6_12/img/preview.jpg"/><meta property="twitter:image" content="https://jobtalle.com/posts/2022_6_12/img/preview.jpg"/><meta property="twitter:description" content="In my fish breeding game Koi Farm, an infinite number of koi patterns can be explored through crossbreeding. The techniques I've used to simulate pattern mutation and crossbreeding are explained in this article, and an interactive javascript based pattern generator and mutator is included to demonstrate the algorithms."/><meta property="twitter:site" content="jobtalle.com"/><meta property="twitter:card" content="summary"/><meta property="twitter:title" content="Digital koi breeding"/><link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet"/><link rel="shortcut icon" type="image/gif" href="img/favicon.gif"/><link rel="stylesheet" type="text/css" href="css/style.css"/><link rel="stylesheet" type="text/css" href="posts/2022_6_12/css/style.css"></head><body><div id="container"><div id="menu-wrapper"><div class="menu-button" id="menu-toggle" onclick="document.getElementById('menu-buttons').classList.toggle('visible')"><div class="burger-slice"></div><div class="burger-slice"></div><div class="burger-slice"></div></div><div id="menu-buttons"><a href="index.html"><div class="menu-button">Blog</div></a><a href="sketches.html"><div class="menu-button">Sketches</div></a><a href="games.html"><div class="menu-button">Games</div></a><a href="work.html"><div class="menu-button">Work</div></a><a href="about.html"><div class="menu-button">About</div></a><a href="contact.html"><div class="menu-button">Contact</div></a></div></div><div id="wrapper" class="container"><div id="header"><h1>Job Talle</h1><h2>On AI, Art & Algorithms</h2></div><div id="content"><h1>Digital koi breeding</h1><span class="date">12 Jun 2022</span><h2>Koi Farm</h2><p>Recently, I launched my game <em><a target="_blank" href="https://store.steampowered.com/app/1518810/Koi_Farm/">Koi Farm</a></em>. Koi Farm is a koi breeding and collecting game, in which the player breeds koi patterns by carefully selecting traits in the parents. This article explains how I implemented <em>crossbreeding</em> and <em>mutation</em> in koi patterns.</p><figure><img src="posts/2022_6_12/img/breeding.gif" alt="Crossbreeding in Koi Farm"><figcaption>Figure 1: Crossbreeding in Koi Farm.</figcaption></figure><p>Koi Farm is open source, so the algorithms discussed here can be seen in their "natural environment" <a target="_blank" href="https://github.com/jobtalle/koi">on GitHub</a>.</p><h2>Procedural mutable koi patterns</h2><p>The fish in Koi Farm have many mutable properties, like shape, size and color, but this article mostly goes into generating the <em>patterns</em> on the fish bodies. Most koi patterns contain spots of varying shapes and sizes.</p><p>The koi pattern generator needs to achieve the following main goals:</p><ul><li>There should be a nearly infinite number of possible patterns.</li><li>The patterns should have plenty of variance.</li><li>The patterns must be able to mutate in small steps.</li></ul><p>The first goal is obvious: the koi are procedurally generated, every fish must be unique. The second goal is important to make the game fun; if all patterns are unique but still look very similar to each other, breeding koi gets boring quickly. Finally, mutation of patterns should happen in small steps. This is crucial for the gameplay. Specific koi patterns desired by the player can be bred by choosing parent koi that look close to the ideal outcome, because their offspring has a chance to arrive there by mutating. For example, if the player wants to breed a "Tancho" pattern (white with a round spot on the head), parents with a single red blob on the back can be bred for several generations until the spot becomes rounder and moves forward. If mutation happens in large steps, or if it would be completely random, there is no way to tell how the offspring of two fish may turn out. In that case, the entire selective breeding gameplay mechanic doesn't work.</p><h2>Slicing noise</h2><p>To create spots, I chose a method based on <em>slicing</em> noise. The following steps generate a texture with random spots:</p><ul><li>Generate a <em>3d noise</em>, in this case <a target="_blank" href="cubic_noise.html">Cubic Noise</a> was used. This type of noise is less uniformly distributed than for example Perlin noise, which is good for variance.</li><li>Construct a <em>3d plane</em> that intersects the generated noise. The plane has the same size as the texture the generated spots are written to.</li><li>For every pixel on the plane corresponding to a pixel on the texture, the 3d noise is read. If the noise value is higher than a given threshold, this pixel is a spot. If it is lower, it's not a spot.</li></ul><figure><div id="pattern-generator"><canvas width="500" height="250" id="renderer"></canvas><div id="palettes"><div id="palette-white-red" class="palette selected"></div><div id="palette-white-orange" class="palette"></div><div id="palette-white-black" class="palette"></div></div><div id="buttons"><button id="button-mutate">Mutate</button><button id="button-randomize">Randomize</button></div><div id="controls" class="controls"><div id="modes" class="controls"><label>Texture:<input type="radio" name="mode" id="mode-texture" checked></label><label>Shaped:<input type="radio" name="mode" id="mode-shape"></label><label>Animated:<input type="radio" name="mode" id="mode-animated"></label></div><div class="controls" id="controls-texture"><label>X:<input type="range" min="-1" max="1" value="0" step="0.005" id="var-x"><input readonly type="text" id="field-x" value="0"></label><label>Y:<input type="range" min="-1" max="1" value="0" step="0.005" id="var-y"><input readonly type="text" id="field-y" value="0"></label><label>Z:<input type="range" min="-1" max="1" value="0" step="0.005" id="var-z"><input readonly type="text" id="field-z" value="0"></label><label>X rotation:<input type="range" min="-180" max="180" value="0" step="1" id="var-x-rotation"><input readonly type="text" id="field-x-rotation" value="0"></label><label>Y rotation:<input type="range" min="-180" max="180" value="0" step="1" id="var-y-rotation"><input readonly type="text" id="field-y-rotation" value="0"></label><label>Threshold:<input type="range" min="0.3" max="0.7" value="0.5" step="0.002" id="var-threshold"><input readonly type="text" id="field-threshold" value="0.5"></label><label>Scale:<input type="range" min="2" max="10" value="4.5" step="0.03" id="var-scale"><input readonly type="text" id="field-scale" value="4.5"></label></div><div class="controls hidden" id="controls-shape"><label>Width:<input type="range" min="0.65" max="1" value="0.8" step="0.001" id="var-width"><input readonly type="text" id="field-width" value="0.8"></label><label>Radius:<input type="range" min="0.4" max="0.65" value="0.5" step="0.002" id="var-radius"><input readonly type="text" id="field-radius" value="0.5"></label><label>Center:<input type="range" min="0.45" max="0.6" value="0.5" step="0.002" id="var-center"><input readonly type="text" id="field-center" value="0.5"></label><label>Thickness:<input type="range" min="0.65" max="1" value="0.9" step="0.002" id="var-thickness"><input readonly type="text" id="field-thickness" value="0.9"></label><label>Eye:<input type="range" min="0.88" max="0.95" value="0.92" step="0.001" id="var-eye-position"><input readonly type="text" id="field-eye-position" value="0.92"></label></div><div class="controls hidden" id="controls-animation"><label>Speed:<input type="range" min="0" max="0.7" value="0.5" step="0.01" id="var-speed"><input readonly type="text" id="field-speed" value="0.5"></label></div></div></div><script type="module" src="posts/2022_6_12/js/main.js"></script></figure><p>The application on the right demonstrates the spot generator. The 3d noise is always the same, but the location and rotation of the 3d plane intersecting it can be changed to change the pattern. The scale of the plane determines the size of the spots; a very small plane contains only a small portion of the noise, while a scaled up plane contains a larger area and therefore more variation.</p><p>The <em>randomize</em> button randomizes the pattern by randomizing every plane parameter. The <em>mutate</em> button mutates the pattern by only changing the parameters a little. Because the plane is "nudged" through the 3d noise by small increments, the new mutated pattern will look similar to the pattern that was generated before, while mutating many times can completely change the pattern to every possible pattern this algorithm can create.</p><h2>Rendering the fish</h2><p>After generating a pattern, the koi can be rendered. The example application has two other modes besides <em>Texture</em>.</p><ul><li><em>Shaped</em> shows a cutout of the spots texture in the shape of a fish. The shape has several parameters, and it also mutates when the mutate button is pressed.</li><li><em>Animated</em> shows the cutout with animation, which resembles the way the fish will look like in the game.</li></ul><p>There is no advanced 3d lighting in Koi Farm, but shading is approximated by making fish bodies darker near the edges. Eyes are rendered on top of the texture. In Koi Farm, several fins are added as well, but they are not shown in this example.</p><h2>Crossbreeding</h2><p>Crossbreeding involves more than just mutating. To "mix" the properties of two parents, child patterns are created by taking the two 3d planes that sliced the parent patterns, and choosing a plane that lies between them. While child planes tend to lie close to either parent, they may be anywhere between. This causes most offspring to look like one of their parents, but if parents are sufficiently different, they can use a plane that doesn't contain any pattern seen on the parent. Finally, after a new 3d plane is created for the child pattern, mutation is applied to add more variance.</p><p>If the parents contain different colors and different patterns, the crossbreeding methods are a bit more involved, but that's outside the scope of this article.</p><h2>Additions</h2><p>In Koi Farm, I've used some additional techniques to make the patterns more interesting:</p><ul><li>Multiple patterns can be layered, so koi can have more than two colors. When mutating, colors may change and patterns may be added, swapped or removed.</li><li>In addition to spots, there are also stripes, ridges and brindle patterns. They are generated in somewhat similar ways.</li><li>Patterns can be stretched to change the shapes further.</li><li>Koi have many more mutable properties than just their pattern. Properties like behaviour, fins, fertility, size and grow speed also mutate.</li></ul><figure><img src="posts/2022_6_12/img/koifarm.jpg" alt="Koi Farm, the koi breeding game"><figcaption>Figure 2: Koi Farm, the koi breeding game.</figcaption></figure><h2>Conclusion</h2><p>The koi pattern generator made the main gameplay mechanic in Koi Farm possible thanks to its ability to mutate and mix procedurally generated patterns. The gameplay was further extended by adding a koi collecting element to the game, which allows player to store their koi as collectible cards, as shown on Figure 2.</p><p>Koi Farm is available on <a target="_blank" href="https://store.steampowered.com/app/1518810">Steam</a> (PC and Linux), <a target="_blank" href="https://jobtalle.itch.io/koifarm">Itch.io</a> (PC, Linux & Mac) and <a target="_blank" href="https://apps.apple.com/us/app/koi-farm/id1607489625">the App Store</a> (iOS), and the source code is available on <a target="_blank" href="https://github.com/jobtalle/koi">GitHub</a>.</p><div id="references"><a href="rendering_symmetry.html" title="Previously: Rendering symmetry"><div class="post-reference post-reference-left">Rendering symmetry</div></a></div></div><div id="footer">&copy Job Talle 2017 - 2023</div><div id="icons"><a href="contact.html"><div class="icon" id="icon-mail" title="Mail"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="283.46px" height="283.46px" viewBox="0 0 283.46 283.46"><path class="icon-body" d="M141.73,0C63.451,0,0,63.451,0,141.73C0,220,63.451,283.46,141.73,283.46 c78.279,0,141.73-63.461,141.73-141.73C283.46,63.451,220.009,0,141.73,0z"/><g fill="#FFF"><polygon points="57.737,193.24 103.702,135.45 57.737,107.352"/><polygon points="172.734,139.48 141.632,158.63 110.479,139.586 62.981,199.308 220.275,199.308"/><polygon points="141.624,149.382 225.722,97.59 225.722,84.152 57.737,84.152 57.737,98.113"/><polygon points="179.492,135.317 225.722,193.488 225.722,106.847"/></g></svg></div></a><a href="https://orcid.org/0000-0003-1946-8407" target="_blank"><div class="icon" title="ORCID"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 283.46 283.46" width="283.46" height="283.46" version="1.1"><path class="icon-body" d="m141.73,0c-78.275,0 -141.73,63.455 -141.73,141.73c0,78.275 63.455,141.73 141.73,141.73c78.275,0 141.73,-63.455 141.73,-141.73c0,-78.275 -63.455,-141.73 -141.73,-141.73z"/><g transform="matrix(1.107422241811154,0,0,1.107422241811154,10.99953146307012,219.93852396886876)" fill="#FFF"><path d="m76.36744,-12.40403l-15.4,0l0,-107.1l15.4,0l0,48.4l0,58.7z"/><path d="m98.96744,-119.50403l41.6,0c39.6,0 57,28.3 57,53.6c0,27.5 -21.5,53.6 -56.8,53.6l-41.8,0l0,-107.2zm15.4,93.3l24.5,0c34.9,0 42.9,-26.5 42.9,-39.7c0,-21.5 -13.7,-39.7 -43.7,-39.7l-23.7,0l0,79.4z"/><path d="m78.76744,-141.80403c0,5.5 -4.5,10.1 -10.1,10.1c-5.6,0 -10.1,-4.6 -10.1,-10.1c0,-5.6 4.5,-10.1 10.1,-10.1c5.6,0 10.1,4.6 10.1,10.1z"/></g></svg></div></a><a href="https://www.github.com/jobtalle" target="_blank"><div class="icon" title="Github"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="283.46px" height="283.46px" viewBox="0 0 283.46 283.46"><path class="icon-body" d="M141.73,0C63.455,0,0,63.455,0,141.73c0,78.275,63.455,141.73,141.73,141.73 c78.275,0,141.73-63.455,141.73-141.73C283.46,63.455,220.005,0,141.73,0z"/><path fill="#FFF" d="M170.925,222.189H149.49h-21.455c0,0,0.062-12.73,0-21.455 c-29.36,6.324-37.554-16.091-37.554-16.091c-5.359-10.731-10.732-16.091-10.732-16.091c-10.731-6.369,0-5.359,0-5.359 c10.732,0,16.091,10.732,16.091,10.732c9.417,15.984,26.167,13.41,32.182,10.729c0-5.357,2.348-13.473,5.359-16.09 c-23.43-2.636-42.931-16.091-42.931-42.914c0-26.822,5.386-32.181,10.75-37.554c-1.081-2.644-5.576-12.424,0.164-26.823 c0,0,10.542,0,21.273,16.091c5.315-5.314,21.454-5.359,26.821-5.359c5.352,0,21.5,0.044,26.813,5.359 c10.729-16.091,21.299-16.091,21.299-16.091c5.74,14.399,1.249,24.179,0.164,26.823c5.359,5.359,10.729,10.731,10.729,37.554 c0,26.823-19.475,40.27-42.911,42.914c3.021,2.617,5.358,11.85,5.358,16.09L170.925,222.189L170.925,222.189z"/></svg></div></a><a href="https://twitter.com/jobtalle" target="_blank"><div class="icon" title="Twitter"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="283.46px" height="283.46px" viewBox="0 0 283.46 283.46"><path class="icon-body" d="M141.73,0C63.451,0,0,63.451,0,141.73C0,220,63.451,283.46,141.73,283.46S283.46,220,283.46,141.73 C283.46,63.451,220.009,0,141.73,0z"/><path fill="#FFF" d="M161.449,78.713c-14.085,5.129-22.987,18.345-21.978,32.811l0.336,5.581l-5.634-0.682 c-20.506-2.622-38.426-11.507-53.645-26.433l-7.441-7.405l-1.904,5.465c-4.057,12.189-1.462,25.068,6.989,33.732  c4.509,4.783,3.49,5.465-4.278,2.622c-2.702-0.912-5.076-1.594-5.297-1.249c-0.788,0.797,1.914,11.162,4.057,15.271 c2.932,5.705,8.902,11.277,15.44,14.589l5.527,2.622l-6.546,0.098c-6.307,0-6.537,0.114-5.855,2.516 c2.25,7.405,11.152,15.271,21.073,18.69l6.989,2.392l-6.085,3.649c-9.018,5.254-19.612,8.212-30.207,8.424 c-5.076,0.115-9.248,0.567-9.248,0.913c0,1.134,13.756,7.512,21.747,10.027c24.005,7.405,52.52,4.208,73.93-8.433 c15.219-9,30.428-26.894,37.532-44.221c3.835-9.221,7.662-26.086,7.662-34.174c0-5.244,0.337-5.926,6.644-12.189 c3.721-3.649,7.211-7.636,7.893-8.77c1.134-2.17,1.01-2.17-4.73-0.23c-9.575,3.419-10.931,2.968-6.191-2.161 c3.49-3.65,7.662-10.258,7.662-12.189c0-0.336-1.691,0.23-3.605,1.249c-2.028,1.143-6.537,2.853-9.921,3.871l-6.085,1.94 l-5.52-3.774c-3.047-2.046-7.316-4.332-9.575-5.014C175.426,76.658,166.639,76.889,161.449,78.713z"/></svg></div></a><a rel="me" href="https://mastodon.gamedev.place/@jobtalle" target="_blank"><div class="icon" title="Mastodon"><svg viewBox="100 71.886 283.46 283.46" width="283.46" height="283.46" xmlns="http://www.w3.org/2000/svg"><g transform="matrix(1, 0, 0, 1, 100, 71.88604)"><path class="icon-body" d="M141.73,0C63.451,0,0,63.451,0,141.73C0,220,63.451,283.46,141.73,283.46S283.46,220,283.46,141.73 C283.46,63.451,220.009,0,141.73,0z"/></g><path fill="#FFF" d="M 321.979 235.324 C 319.488 248.139 299.668 262.165 276.905 264.883 C 265.034 266.3 253.347 267.602 240.884 267.03 C 220.503 266.096 204.421 262.165 204.421 262.165 C 204.421 264.149 204.543 266.038 204.788 267.806 C 207.437 287.92 224.733 289.125 241.116 289.686 C 257.651 290.252 272.374 285.61 272.374 285.61 L 273.053 300.558 C 273.053 300.558 261.487 306.768 240.884 307.911 C 229.523 308.535 215.416 307.625 198.986 303.276 C 163.35 293.844 157.222 255.858 156.284 217.316 C 155.998 205.873 156.174 195.082 156.174 186.058 C 156.174 146.646 181.997 135.093 181.997 135.093 C 195.017 129.114 217.359 126.599 240.586 126.41 L 241.156 126.41 C 264.383 126.599 286.74 129.114 299.759 135.093 C 299.759 135.093 325.581 146.646 325.581 186.058 C 325.581 186.058 325.905 215.135 321.979 235.324"/><path class="icon-body" d="M 295.123 189.115 L 295.123 236.835 L 276.216 236.835 L 276.216 190.517 C 276.216 180.754 272.109 175.798 263.891 175.798 C 254.805 175.798 250.251 181.677 250.251 193.301 L 250.251 218.654 L 231.457 218.654 L 231.457 193.301 C 231.457 181.677 226.903 175.798 217.817 175.798 C 209.6 175.798 205.491 180.754 205.491 190.517 L 205.491 236.835 L 186.586 236.835 L 186.586 189.115 C 186.586 179.362 189.069 171.612 194.057 165.878 C 199.201 160.144 205.937 157.204 214.299 157.204 C 223.974 157.204 231.3 160.923 236.145 168.361 L 240.854 176.255 L 245.564 168.361 C 250.408 160.923 257.733 157.204 267.41 157.204 C 275.77 157.204 282.507 160.144 287.652 165.878 C 292.638 171.612 295.123 179.362 295.123 189.115"/></svg></div></a><a href="https://www.linkedin.com/in/jobtalle" target="_blank"><div class="icon" title="LinkedIn"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="283.46px" height="283.46px" viewBox="0 0 283.46 283.46"><path class="icon-body" d="M141.73,0C63.451,0,0,63.451,0,141.73C0,220,63.451,283.46,141.73,283.46 c78.279,0,141.73-63.461,141.73-141.73C283.46,63.451,220.009,0,141.73,0z"/><path fill="#FFF" d="M215.199,203.223v-54.362c0-29.125-15.545-42.679-36.281-42.679c-16.732,0-24.229,9.204-28.398,15.661 v-13.438H119c0.417,8.902,0,94.817,0,94.817h31.517v-52.954c0-2.826,0.204-5.66,1.037-7.681c2.275-5.66,7.458-11.523,16.166-11.523 c11.408,0,15.971,8.689,15.971,21.438v50.729L215.199,203.223L215.199,203.223z M85.791,95.464c10.984,0,17.832-7.29,17.832-16.387 c-0.204-9.301-6.848-16.379-17.628-16.379c-10.78,0-17.822,7.078-17.822,16.379c0,9.106,6.838,16.387,17.424,16.387H85.791z M101.549,203.223v-94.817H70.041v94.817H101.549z"/></svg></div></a><a type="application/rss+xml" href="rss.xml" target="_blank"><div class="icon" title="RSS"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" width="283.46px" height="283.46px" viewBox="0 0 283.46 283.46"><path class="icon-body" d="M141.586,0C63.387,0,0,63.386,0,141.587c0,78.191,63.387,141.586,141.586,141.586 c78.2,0,141.587-63.396,141.587-141.586C283.173,63.386,219.787,0,141.586,0z"/><path fill="#FFF" d="M192.071,200.408h26.035c0-74.634-60.714-135.393-135.339-135.393v25.963 C143.029,90.978,192.071,140.074,192.071,200.408z M100.792,200.451c9.982,0,18.043-8.016,18.043-17.953 c0-9.886-8.061-17.993-18.043-17.993c-9.938,0-18.017,8.107-18.017,17.993C82.767,192.435,90.846,200.451,100.792,200.451z M146.064,200.416L146.064,200.416h26.061c0-49.289-40.096-89.385-89.368-89.385v25.954c16.902,0,32.786,6.601,44.75,18.584 C139.472,167.505,146.064,183.461,146.064,200.416z"/></svg></div></a></div></div></div></body></html>