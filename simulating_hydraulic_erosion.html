<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-109031298-1"></script><script src="js/google.js"></script><title>Job Talle | Simulating hydraulic erosion</title><meta charset="UTF-8"><meta name="description" content="todo"/><meta name="keywords" content="software development, AI, algorithms, programming, Job Talle"/><meta name="author" content="Job Talle"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:locale" content="en_US"/><meta property="og:title" content="Simulating hydraulic erosion"/><meta property="og:url" content="https://jobtalle.com/simulating_hydraulic_erosion.html"/><meta property="og:description" content="todo"/><meta property="og:image" content="https://jobtalle.com/posts/2020_5_20/img/preview.jpg"/><meta property="twitter:image" content="https://jobtalle.com/posts/2020_5_20/img/preview.jpg"/><meta property="twitter:description" content="todo"/><meta property="twitter:site" content="jobtalle.com"/><meta property="twitter:card" content="summary"/><meta property="twitter:title" content="Simulating hydraulic erosion"/><link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet"/><link rel="shortcut icon" type="image/gif" href="img/favicon.gif"/><link rel="stylesheet" type="text/css" href="css/style.css"/></head><body><div id="container"><div id="menu-wrapper"><div id="menu-buttons"><a href="index.html"><div class="menu-button">Blog</div></a><a href="sketches.html"><div class="menu-button">Art</div></a><a href="about.html"><div class="menu-button">About</div></a><a href="contact.html"><div class="menu-button">Contact</div></a></div></div><div id="wrapper" class="container"><div id="header"><h1>Job Talle</h1><h2>On software development, AI & Algorithms</h2></div><div id="content"><h1>Simulating hydraulic erosion</h1><span class="date">20 May 2020</span><h2>Simulating hydraulic erosion</h2><p><em>Hydraulic erosion</em> is the process by which water transforms terrain over time. This is mostly caused by rainfall, but also by ocean waves hitting the shore and the flow of rivers. Figure 1 shows the considerable effects that a small stream has had on the rocky environment around it. When creating realistically looking environments, the effects of erosion need to be accounted for. I have experimented with procedural terrain generation before to generate scenes for <a href="layered_voxel_rendering.html" target="_blank">layered voxel rendering</a> and to demonstrate <a href="cubic_noise.html" target="_blank">cubic noise</a>. These terrains were very basic and did not account for erosion. Therefore, they lack a lot of detail, making them unrealistic at closer inspection.</p><figure title="A small waterfall"><img src="posts/2020_5_20/img/waterfall.jpg"><figcaption>Figure 1: A small waterfall.</figcaption></figure><p>In this article, I will detail a simple and fast method that approximates the effects of hydraulic erosion. The aim of this method is to create believable environments rather than reaching a high degree of realism. Fidelity may be sacrificed for the sake of speed, as long as the results look natural. Summarized, the method should do the following:</p><ul><li>The results must look <em>natural</em>.</li><li>The algorithm must be <em>simple</em>.</li><li>The algorithm must be <em>fast</em>.</li><li>The algorithm should simulate hydraulic erosion caused by <em>rainfall</em> and <em>rivers</em>.</li></ul><h2>Multiple approaches</h2><p>There are several different approaches when it comes to simulating erosion. All methods simulate the same phenomenon: water moving from high places to low places, eroding terrain as it flows, and depositing sediment as they go further down their paths. This process always results in a number of recognizable terrain features like gulleys and valleys where rivers flow, deltas where they meet their destination and <a href="https://en.wikipedia.org/wiki/Alluvial_fan" target="_blank">alluvial fans</a> where smaller streams combine into bigger rivers. While reading about this topic, I have encountered the following distinct strategies in research literature:</p><ul><li>Erosion is simulated by keeping track of where water is for every position on the terrain. A grid (or 2D array) is created for the environment, and water levels and pressures are kept for every cell. When updating, the pressures determine where the water flows to. While flowing, water moves sediment around.</li><li>Erosion is simulated by dropping many particles simulating raindrops on the terrain. The particles then move down the slopes of the terrain. They can bring sediment with them or deposit it.</li></ul><figure title="An island with simulated erosion"><img src="posts/2020_5_20/img/island.jpg"><figcaption>Figure 2: An island after erosion has been applied to it.</figcaption></figure><p>Mostly for performance reasons, I've chosen to implement a drop based method. Because most drops don't flow very far, many inactive drop simulations can be terminated early and the bulk of the processing power will go to the drops that actually carve out terrain features. The grid based simulation will need to simulate every part on the terrain for every update cycle.</p><h2>Snowballs</h2><p>The drops in the simulation can be seen as <em>snowballs</em> instead of raindrops. Within the context of the simulation, I believe this is a better analogy. The snowballs start small when they are dropped, but gain more material as they roll down the hills. When they become too big, they start shedding material as they go. When they stop rolling in valleys or in the sea, the snowballs fall apart and leave their material on the terrain.</p><p>The complete erosion algorithm (in Javascript) can be read below. This code uses a <code class="prettyprint lang-js">heightMap</code> object to erode. This height map can be read from and written to, and the <code class="prettyprint lang-js">sampleNormal</code> function can be used to get the surface normal. This is a 3D vector pointing upwards from the terrain, so it can be used to determine the slope direction and steepness.</p><pre class="prettyprint noscroll">/**
 * Let a snowball erode the height map
 * @param {Number} x The X coordinate to start at
 * @param {Number} y The Y coordinate to start at
 */
trace = function(x, y) {
  const ox = (random.getFloat() * 2 - 1) * radius; // The X offset
  const oy = (random.getFloat() * 2 - 1) * radius; // The Y offset
  let sediment = 0; // The amount of carried sediment
  let xp = x; // The previous X position
  let yp = y; // The previous Y position
  let vx = 0; // The horizontal velocity
  let vy = 0; // The vertical velocity

  for (let i = 0; i < maxIterations; ++i) {
    // Get the surface normal of the terrain at the current location
    const surfaceNormal = heightMap.sampleNormal(x + ox, y + oy);

    // If the terrain is flat, stop simulating, the snowball cannot roll any further
    if (surfaceNormal.y === 1)
      break;

    // Calculate the deposition and erosion rate
    const deposit = sediment * depositionRate * surfaceNormal.y;
    const erosion = erosionRate * (1 - surfaceNormal.y) * Math.min(1, i * iterationScale);

    // Change the sediment on the place this snowball came from
    heightMap.change(xp, yp, deposit - erosion);
    sediment += erosion - deposit;

    vx = friction * vx + surfaceNormal.x * speed;
    vy = friction * vy + surfaceNormal.z * speed;
    xp = x;
    yp = y;
    x += vx;
    y += vy;
  }
};

// Simulate 50000 snowballs
const snowballs = 50000;

for (let i = 0; i < snowballs; ++i)
  trace(
    random.getFloat() * width,
    random.getFloat() * height);

// Blur the height map to smooth out the effects
heightMap.blur();
</pre><p>The algorithm has a few notable properties:</p><ul><li>The variables <code class="prettyprint lang-js">ox</code> and <code class="prettyprint lang-js">oy</code> encode the <em>offset</em> of a snowball. They are used to read the terrain slope with a certain offset to make the snowball motion a bit rougher, which prevents snowball paths from converging too much.</li><li>When the surface normal points perfectly upwards (when the y value of that normal equals one), the snowball terminates. In practice, this means that snowballs that have reached the edge of the simulated are or the sea floor stop simulating there. Because nothing happens in those areas, simulating erosion would be a waste of processing power.</li><li>When changing the amount of sediment, the snowball edits the height map at its previous position instead of its current position. Erosion and deposition take place behind it to prevent snowballs from digging themselves in.</li><li>After simulating erosion, gaussian blur is applied to the height map. Because the height map in these examples has a low resolution, blur is required to keep the surfaces smooth enough to be visually appealing.</li></ul><h2>Results</h2><figure title="Results">    <img src="posts/2020_5_20/img/results.jpg">    <figcaption>Figure 3: The results of the erosion algorithm.</figcaption></figure><p>Applying the algorithm above with varying snowball counts gives the results rendered in Figure 3. The "starting material" for the algorithm is shown in the first image. This island shape was generated using a very similar algorithm to the one I used in <a href="layered_voxel_rendering.html" target="_blank">my layered voxel rendering example terrains</a>. While the shape does contain some details and ridges, it is very smooth and contains no traces of hydraulic erosion.</p><p>The second image shows the same island after dropping 35.000 snowballs on it. They are dropped randomly and evenly spaced. Because of the random initial conditions of the starting shape, valleys and river like structures form where the snowballs find the quickest way to the sea.</p><p>The third image shows the same island after dropping 50.000 snowballs. Compared to the previous image, no new details form, although they are more pronounced.</p><p>The last image shows the island after dropping 100.000 snowballs. This is clearly too much; the ridges become very deep and the shore is very rough.</p><h2>Conclusion</h2><h2>Appendix: rendering shore waves</h2><div id="references"><a href="neuroevolution_in_squids.html" title="Previously: Neuroevolution in squids"><div class="post-reference post-reference-left">Neuroevolution in squids</div></a></div></div><div id="footer">&copy Job Talle 2017 - 2020</div><div id="icons"><a href="contact.html"><div class="icon" id="icon-mail" title="Mail"></div></a><a href="https://www.github.com/jobtalle" target="_blank"><div class="icon" id="icon-github" title="Github"></div></a><a href="https://twitter.com/jobtalle" target="_blank"><div class="icon" id="icon-twitter" title="Twitter"></div></a><a href="https://www.linkedin.com/in/jobtalle" target="_blank"><div class="icon" id="icon-linkedin" title="LinkedIn"></div></a><a type="application/rss+xml" href="rss.xml" target="_blank"><div class="icon" id="icon-rss" title="RSS"></div></a></div></div></div><script src="lib/prettify/run_prettify.js"></script></body></html>